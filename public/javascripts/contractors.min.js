"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=exports.canUpdate,t=exports.urlPrefix;cityssm.htmlModalFolder=t+"/html/";const a=document.querySelector("#form--filters"),r=document.querySelector("#container--results");let o=[];const s={tradeCategories:[],healthSafetyStatuses:[],insuranceCompanyNames:[]},n=e=>{e.preventDefault();const t=document.querySelector("#contractor--docuShareCollectionID").value;""===t?cityssm.alertModal("DocuShare Collection ID Not Available","Note that Hire Ready contractors will have their Collection IDs populated automatically.","OK","warning"):window.open((e=>exports.docuShareRootURL+"/dsweb/View/Collection-"+e)(t))};let c,i=!1;const l=e=>{e.preventDefault();const a=e.currentTarget,r=a.getAttribute("data-action");cityssm.postJSON(t+"/contractors/"+r,a,e=>{e.success?(cityssm.alertModal("Update Saved Successfully","Close the contractor popup window to refresh your search results.","OK","success"),i=!0):cityssm.alertModal("Update Failed","Please try again.","OK","danger")})},d=e=>{e.preventDefault();const a=document.querySelector("#tradeCategories--tradeCategoryID").value;if(""===a)return void cityssm.alertModal("No Trade Category Selected","Please select a trade category from the list.","OK","warning");if(c.has(Number.parseInt(a,10)))return void cityssm.alertModal("Trade Category Already Included","No need to add it twice.","OK","info");const r=e.currentTarget;cityssm.postJSON(t+"/contractors/doAddTradeCategory",r,e=>{if(e.success){const e=Number.parseInt(r.querySelector(".contractor--contractorID").value,10),t=(e=>{return s.tradeCategories.find(t=>t.tradeCategoryID===e)})(Number.parseInt(a,10)),o=p(e,t),n=document.querySelector("#contractor--tradeCategories");n.classList.contains("panel")||(n.innerHTML="",n.classList.add("panel")),n.prepend(o),c.set(t.tradeCategoryID,t.tradeCategory),i=!0}else cityssm.alertModal("Adding Trade Category Failed","An error occurred while trying to add the trade category. Is it already included?","OK","warning")})},u=e=>{const a=e.currentTarget,r=document.querySelector("#contractor--docuShareCollectionID"),o=r.value;let s;const n=()=>{cityssm.openHtmlModal("contractor-createDSCollection-loading",{onshown:(e,o)=>{s=o,(()=>{const e=a.getAttribute("data-contractor-id");cityssm.postJSON(t+"/contractors/doCreateDocuShareCollection",{contractorID:e},e=>{s(),e.success?r.value=e.docuShareCollectionID:cityssm.alertModal("DocuShare Collection Not Created",cityssm.escapeHTML(e.message),"OK","danger")})})()}})};""===o?cityssm.confirmModal("Create a New Collection in DocuShare","Are you sure you want to create a new DocuShare Collection for this contractor?","Yes, Create Collection","info",n):cityssm.confirmModal("Create a New Collection in DocuShare","<strong>A Collection already exists for this contractor.</strong> Are you sure you want to abandon the existing Collection and create a new DocuShare Collection?","Yes, Abandon and Create","danger",n)},m=e=>{const a=e.currentTarget;cityssm.confirmModal("Remove Trade Category?","Are you sure you want to remove the trade category from the contractor?","Yes, Remove It","warning",()=>{const e=a.getAttribute("data-contractor-id"),r=a.getAttribute("data-trade-category-id");cityssm.postJSON(t+"/contractors/doRemoveTradeCategory",{contractorID:e,tradeCategoryID:r},e=>{e.success?(a.closest(".panel-block").remove(),c.delete(Number.parseInt(r,10)),i=!0):cityssm.alertModal("Remove Failed","An error occurred removing this trade category. Please try again.","OK","danger")})})},p=(t,a)=>{const r=document.createElement("div");if(r.className="panel-block",r.innerHTML='<span class="panel-icon"><i class="fas fa-book" aria-hidden="true"></i></span><span class="is-flex-grow-1">'+cityssm.escapeHTML(a.tradeCategory)+"</span>",e){const e=document.createElement("button");e.className="button is-small is-danger is-inverted is-edit-control-flex",e.type="button",e.dataset.contractorId=t.toString(),e.dataset.tradeCategoryId=a.tradeCategoryID.toString(),e.innerHTML='<i class="fas fa-times" aria-hidden="true"></i><span class="sr-only">Remove</span>',e.addEventListener("click",m),r.append(e)}return r},y=e=>{const a=e.currentTarget,r=a.closest("form");switch(r.dataset.action){case"doUpdateHealthSafety":(()=>{const e=()=>{const e=document.createElement("optgroup");e.label="Options";for(const t of s.healthSafetyStatuses)e.insertAdjacentHTML("beforeend","<option>"+cityssm.escapeHTML(t)+"</option>");document.querySelector("#contractor--healthSafety_status").append(e)};s.healthSafetyStatuses.length>0?e():cityssm.postJSON(t+"/contractors/doGetHealthSafetyOptions",{},t=>{s.healthSafetyStatuses=t.healthSafetyStatuses,e()})})();break;case"doUpdateLegal":document.querySelector("#contractor--legal_isSatisfactory").insertAdjacentHTML("beforeend",'<optgroup label="Options"><option value="1">Approved</option><option value="0">Declined</option></optgroup>');break;case"doUpdateInsurance":(()=>{const e=()=>{const e=document.querySelector("#contractor--insurance_company-datalist");for(const t of s.insuranceCompanyNames)e.insertAdjacentHTML("beforeend",'<option value="'+cityssm.escapeHTML(t)+'"></option>')};s.insuranceCompanyNames.length>0?e():cityssm.postJSON(t+"/contractors/doGetInsuranceOptions",{},t=>{s.insuranceCompanyNames=t.insuranceCompanyNames,e()})})()}r.addEventListener("submit",l),r.querySelector("fieldset").disabled=!1,a.remove()},h=e=>{const t=e.currentTarget.closest(".control"),a=t.closest("form");a.classList.add("is-edit-mode"),a.addEventListener("submit",l);const r=document.querySelector("#contractor--docuShareCollectionID-create");r.addEventListener("click",u),r.dataset.contractorId=a.querySelector(".contractor--contractorID").value,document.querySelector("#contractor--docuShareCollectionID").disabled=!1,t.remove()},f=e=>{const a=e.currentTarget.closest(".is-unlock-tradecategories-container"),r=document.querySelector("#form--tradeCategories");document.querySelector("#contractor--tradeCategories").classList.add("is-edit-mode"),(()=>{const e=()=>{const e=document.querySelector("#tradeCategories--tradeCategoryID");for(const t of s.tradeCategories)e.insertAdjacentHTML("beforeend",'<option value="'+t.tradeCategoryID.toString()+'">'+t.tradeCategory+"</option>")};s.tradeCategories.length>0?e():cityssm.postJSON(t+"/contractors/doGetAllTradeCategories",{},t=>{s.tradeCategories=t.tradeCategories,e()})})(),r.addEventListener("submit",d),r.classList.remove("is-hidden"),a.remove()},g=a=>{a.preventDefault();const r=Number.parseInt(a.currentTarget.getAttribute("data-index"),10),s=o[r];cityssm.openHtmlModal("contractor-view",{onshow:a=>{document.querySelector("html").classList.add("is-clipped"),c=new Map,cityssm.postJSON(t+"/contractors/doGetTradeCategoriesByContractorID",{contractorID:s.contractorID},e=>{const t=document.querySelector("#contractor--tradeCategories");if(0!==e.tradeCategories.length){t.innerHTML="",t.classList.add("panel");for(const a of e.tradeCategories){c.set(a.tradeCategoryID,a.tradeCategory);const e=p(s.contractorID,a);t.append(e)}}else t.innerHTML='<div class="message is-warning"><div class="message-body">There are no trade categories assigned to this contractor.</div></div>'}),document.querySelector("#contractor--contractor_name").textContent=s.contractor_name;const r=(s.contractor_city?s.contractor_city+", ":"")+(s.contractor_province||"");document.querySelector("#contractor--location").textContent=r&&""!==r?r:"(Unavailable)",document.querySelector("#contractor--phone_name").textContent=s.phone_name&&""!==s.phone_name?s.phone_name:"(Unavailable)",document.querySelector("#contractor--phone_number").textContent=s.phone_number&&""!==s.phone_number?s.phone_number:"(Unavailable)",s.docuShareCollectionID&&(document.querySelector("#contractor--docuShareCollectionID").value=s.docuShareCollectionID.toString()),document.querySelector("#contractor--docuShareCollectionID-link").addEventListener("click",n),document.querySelector("#contractor--healthSafety_status").innerHTML=null===s.healthSafety_status||""===s.healthSafety_status?'<option value="">(Not Set)</option>':"<option>"+cityssm.escapeHTML(s.healthSafety_status)+"</option>";const o=s.legal_isSatisfactory?'<option value="1">Approved</option>':'<option value="0">Declined</option>';if(document.querySelector("#contractor--legal_isSatisfactory").innerHTML=o,document.querySelector("#contractor--wsib_accountNumber").value=s.wsib_accountNumber,document.querySelector("#contractor--wsib_firmNumber").value=s.wsib_firmNumber,s.wsib_effectiveDate){const e=new Date(s.wsib_effectiveDate),t=cityssm.dateToString(e);document.querySelector("#contractor--wsib_effectiveDate").value=t}if(s.wsib_expiryDate){const e=new Date(s.wsib_expiryDate),t=cityssm.dateToString(e);document.querySelector("#contractor--wsib_expiryDate").value=t}if(s.wsib_isIndependent&&(document.querySelector("#contractor--wsib_isIndependent").checked=!0),document.querySelector("#contractor--insurance_company").value=s.insurance_company||"",document.querySelector("#contractor--insurance_policyNumber").value=s.insurance_policyNumber||"",document.querySelector("#contractor--insurance_amount").value=s.insurance_amount.toString(),s.insurance_expiryDate){const e=new Date(s.insurance_expiryDate),t=cityssm.dateToString(e);document.querySelector("#contractor--insurance_expiryDate").value=t}if(e){const e=a.querySelectorAll(".contractor--contractorID");for(const t of e)t.value=s.contractorID.toString()}},onshown:t=>{if(e){const e=t.querySelector(".is-unlock-contractor-control");e.classList.remove("is-hidden"),e.querySelector("button").addEventListener("click",h);const a=t.querySelectorAll(".is-unlock-tradecategories-container")[0];a.classList.remove("is-hidden"),a.querySelector("button").addEventListener("click",f);const r=t.querySelectorAll(".is-unlock-button");for(const e of r)e.classList.remove("is-hidden"),e.addEventListener("click",y)}},onhidden:()=>{i&&(b(),i=!1)},onremoved:()=>{document.querySelector("html").classList.remove("is-clipped")}})},S=e=>e.isContractor&&e.healthSafety_isSatisfactory&&e.legal_isSatisfactory&&e.wsib_isSatisfactory&&e.insurance_isSatisfactory,v=(e,t)=>{const a=document.createElement("div");a.className="panel-block is-block";const r=document.createElement("div");return r.className="columns is-mobile is-multiline",r.innerHTML='<div class="column is-full-mobile is-full-tablet is-half-widescreen"><a class="is-size-5 has-text-weight-bold" data-index="'+t.toString()+'" role="button" href="#">'+cityssm.escapeHTML(e.contractor_name)+"</a><br />"+(S(e)?'<span class="icon"><i class="fas fa-phone" aria-hidden="true"></i></span> <span>'+e.phone_number+"</span>":'<span class="has-text-weight-semibold has-text-danger"><span class="icon"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i></span> Not Hire Ready</span>')+'</div><div class="column pt-4 has-text-centered">'+(e=>{return'<span class="icon">'+(e.healthSafety_isSatisfactory?'<i class="fas fa-2x fa-check-circle has-text-success" aria-hidden="true"></i>':'<i class="fas fa-2x fa-times-circle has-text-danger" aria-hidden="true"></i>')+'</span><br /><span class="is-size-7 has-text-weight-semibold">Health & Safety</span>'})(e)+'</div><div class="column pt-4 has-text-centered">'+(e=>{return'<span class="icon">'+(e.legal_isSatisfactory?'<i class="fas fa-2x fa-check-circle has-text-success" aria-hidden="true"></i>':'<i class="fas fa-2x fa-times-circle has-text-danger" aria-hidden="true"></i>')+'</span><br /><span class="is-size-7 has-text-weight-semibold">Legal</span>'})(e)+'</div><div class="column pt-4 has-text-centered">'+(e=>{let t="";return e.wsib_isIndependent?t="Independent Contractor":e.wsib_isSatisfactory&&(t="Expires "+cityssm.dateToString(new Date(e.wsib_expiryDate))),'<span class="icon"'+(""===t?"":' data-tooltip="'+t+'"')+">"+(e.wsib_isSatisfactory?'<i class="fas fa-2x fa-check-circle has-text-success" aria-hidden="true"></i>':'<i class="fas fa-2x fa-times-circle has-text-danger" aria-hidden="true"></i>')+'</span><br /><span class="is-size-7 has-text-weight-semibold">WSIB</span>'})(e)+'</div><div class="column pt-4 has-text-centered">'+(e=>{let t="";return e.insurance_isSatisfactory?t="Expires "+cityssm.dateToString(new Date(e.insurance_expiryDate)):e.insurance_expiryDate&&(t="Expired "+cityssm.dateToString(new Date(e.insurance_expiryDate))),'<span class="icon"'+(""===t?"":' data-tooltip="'+t+'"')+">"+(e.insurance_isSatisfactory?'<i class="fas fa-2x fa-check-circle has-text-success" aria-hidden="true"></i>':'<i class="fas fa-2x fa-times-circle has-text-danger" aria-hidden="true"></i>')+'</span><br /><span class="is-size-7 has-text-weight-semibold">Insurance</span>'})(e)+"</div>",r.querySelector("a").addEventListener("click",g),a.append(r),a},b=()=>{o=[],cityssm.clearElement(r),r.innerHTML='<div class="has-text-centered p-4"><span class="icon"><i class="fas fa-4x fa-spinner fa-pulse" aria-hidden="true"></i></span></div>',cityssm.postJSON(t+"/contractors/doGetContractors",a,e=>{if(0===(o=e.contractors).length)return void(r.innerHTML='<div class="message is-info"><div class="message-body">There are no contractors available that meet your search criteria.</div></div>');let t=0;const a=document.createElement("div");a.className="panel";for(const[e,r]of o.entries()){const o=v(r,e);a.append(o),S(r)&&(t+=1)}let s="";0===t?s+='<span class="has-text-danger">No Displayed Contractors are Hire Ready</span>':t===o.length?s+='<span class="has-text-success">All Displayed Contractors are Hire Ready</span>':s+='<span class="has-text-success">'+t.toString()+" out of "+o.length.toString()+" Contractors are Hire Ready</span>",r.innerHTML='<div class="mb-5 has-text-centered has-text-weight-bold">Displaying '+o.length.toString()+" contractor"+(1===o.length?"":"s")+"<br />"+s+"</div>",r.append(a)})};a.addEventListener("submit",e=>{e.preventDefault()}),b(),document.querySelector("#filter--contractorName").addEventListener("change",b),document.querySelector("#filter--tradeCategoryID").addEventListener("change",b),document.querySelector("#filter--hireStatus").addEventListener("change",b)})();